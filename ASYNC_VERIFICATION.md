# DayBetter Services é›†æˆ - å¼‚æ­¥æ“ä½œéªŒè¯æŠ¥å‘Š

## âœ… éªŒè¯çŠ¶æ€ï¼šå®Œå…¨ç¬¦åˆæ ‡å‡†

**éªŒè¯æ—¶é—´**: 2025-10-23  
**éªŒè¯æ ‡å‡†**: Home Assistant å¼‚æ­¥ç¼–ç¨‹è§„èŒƒ

---

## ğŸ“‹ éªŒè¯ç›®æ ‡

ç¡®ä¿æ‰€æœ‰ä»£ç ç¬¦åˆ Home Assistant çš„å¼‚æ­¥ç¼–ç¨‹è¦æ±‚ï¼š

1. âœ… æ‰€æœ‰ I/O æ“ä½œï¼ˆç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶æ“ä½œï¼‰å¿…é¡»æ˜¯å¼‚æ­¥çš„
2. âœ… ä¸èƒ½æœ‰é˜»å¡äº‹ä»¶å¾ªç¯çš„åŒæ­¥æ“ä½œ
3. âœ… æ­£ç¡®ä½¿ç”¨ `async`/`await` å…³é”®å­—
4. âœ… æ•°æ®å¤„ç†å¯ä»¥æ˜¯åŒæ­¥çš„ï¼ˆåªè¦ä¸æ¶‰åŠ I/Oï¼‰
5. âœ… ä¼ æ„Ÿå™¨å±æ€§è®¿é—®åº”è¯¥æ˜¯åŒæ­¥çš„ï¼ˆä»ç¼“å­˜è¯»å–ï¼‰

---

## ğŸ“‚ æ–‡ä»¶æ£€æŸ¥æ˜ç»†

### 1. `__init__.py` - âœ… å®Œå…¨å¼‚æ­¥

#### å‡½æ•°åˆ†æ

| å‡½æ•°å | ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|------|
| `async_setup` | å¼‚æ­¥ | âœ… | æ­£ç¡®å£°æ˜ä¸ºå¼‚æ­¥å‡½æ•° |
| `async_setup_entry` | å¼‚æ­¥ | âœ… | æ­£ç¡®ä½¿ç”¨ await è°ƒç”¨å¼‚æ­¥æ“ä½œ |
| `async_unload_entry` | å¼‚æ­¥ | âœ… | æ­£ç¡®å¤„ç†èµ„æºæ¸…ç† |

#### å…³é”®å¼‚æ­¥æ“ä½œ

```python
# âœ… æ­£ç¡®ï¼šå¼‚æ­¥åˆå§‹åŒ– coordinator
await coordinator.async_config_entry_first_refresh()

# âœ… æ­£ç¡®ï¼šå¼‚æ­¥è®¾ç½®å¹³å°
await hass.config_entries.async_forward_entry_setups(entry, PLATFORMS)

# âœ… æ­£ç¡®ï¼šå¼‚æ­¥å¸è½½å¹³å°
await hass.config_entries.async_unload_platforms(entry, PLATFORMS)

# âœ… æ­£ç¡®ï¼šå¼‚æ­¥å…³é—­ API è¿æ¥
await entry_data["api"].close()
```

---

### 2. `config_flow.py` - âœ… å®Œå…¨å¼‚æ­¥

#### å‡½æ•°åˆ†æ

| å‡½æ•°å | ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|------|
| `async_step_user` | å¼‚æ­¥ | âœ… | é…ç½®æµç¨‹æ­£ç¡®ä½¿ç”¨å¼‚æ­¥ |

#### å…³é”®å¼‚æ­¥æ“ä½œ

```python
# âœ… æ­£ç¡®ï¼šå¼‚æ­¥é›†æˆè®¾å¤‡
integrate_result = await api.integrate(user_code)

# âœ… æ­£ç¡®ï¼šå¼‚æ­¥è·å–è®¾å¤‡åˆ—è¡¨
await api_with_token.fetch_devices()

# âœ… æ­£ç¡®ï¼šå¼‚æ­¥è·å– PID
await api_with_token.fetch_pids()

# âœ… æ­£ç¡®ï¼šåœ¨ finally å—ä¸­å¼‚æ­¥å…³é—­è¿æ¥
await api_with_token.close()
await api.close()
```

**æœ€ä½³å®è·µ**:
- âœ… ä½¿ç”¨ try-finally ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾
- âœ… å³ä½¿å‘ç”Ÿå¼‚å¸¸ä¹Ÿä¼šå…³é—­ API è¿æ¥

---

### 3. `coordinator.py` - âœ… å®Œå…¨å¼‚æ­¥

#### å‡½æ•°åˆ†æ

| å‡½æ•°å | ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|------|
| `_async_update_data` | å¼‚æ­¥ | âœ… | æ•°æ®æ›´æ–°æ–¹æ³•æ­£ç¡®å®ç° |

#### å…³é”®å¼‚æ­¥æ“ä½œ

```python
# âœ… æ­£ç¡®ï¼šå¼‚æ­¥è·å–è®¾å¤‡çŠ¶æ€
statuses = await self._api.fetch_device_statuses()

# âœ… æ­£ç¡®ï¼šå¼‚æ­¥è·å–è®¾å¤‡åˆ—è¡¨
self._devices = await self._api.fetch_devices()

# âœ… æ­£ç¡®ï¼šå¼‚æ­¥è·å– PID
self._pids = await self._api.fetch_pids()

# âœ… æ­£ç¡®ï¼šåŒæ­¥æ•°æ®å¤„ç†ï¼ˆä¸æ¶‰åŠ I/Oï¼‰
sensor_devices = self._api.filter_sensor_devices(self._devices, self._pids)
return self._api.merge_device_status(sensor_devices, statuses)
```

**è®¾è®¡æ¨¡å¼**:
- âœ… ä½¿ç”¨ DataUpdateCoordinator ç»Ÿä¸€ç®¡ç†æ•°æ®æ›´æ–°
- âœ… é¿å…ä¼ æ„Ÿå™¨ç›´æ¥è¿›è¡Œç½‘ç»œè¯·æ±‚
- âœ… æ•°æ®ç¼“å­˜åœ¨ coordinator ä¸­

---

### 4. `daybetter_api.py` - âœ… å®Œå…¨å¼‚æ­¥

#### å‡½æ•°åˆ†æ

| å‡½æ•°å | ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|------|
| `__init__` | åŒæ­¥ | âœ… | æ„é€ å‡½æ•°ï¼Œä¸æ¶‰åŠ I/O |
| `integrate` | å¼‚æ­¥ | âœ… | ç½‘ç»œè¯·æ±‚æ­£ç¡®å¼‚æ­¥åŒ– |
| `fetch_devices` | å¼‚æ­¥ | âœ… | ç½‘ç»œè¯·æ±‚æ­£ç¡®å¼‚æ­¥åŒ– |
| `fetch_pids` | å¼‚æ­¥ | âœ… | ç½‘ç»œè¯·æ±‚æ­£ç¡®å¼‚æ­¥åŒ– |
| `fetch_device_statuses` | å¼‚æ­¥ | âœ… | ç½‘ç»œè¯·æ±‚æ­£ç¡®å¼‚æ­¥åŒ– |
| `filter_sensor_devices` | åŒæ­¥ | âœ… | çº¯æ•°æ®å¤„ç†ï¼Œåˆç† |
| `merge_device_status` | åŒæ­¥ | âœ… | çº¯æ•°æ®å¤„ç†ï¼Œåˆç† |
| `close` | å¼‚æ­¥ | âœ… | èµ„æºæ¸…ç†æ­£ç¡®å¼‚æ­¥åŒ– |

#### å…³é”®å¼‚æ­¥æ“ä½œ

```python
# âœ… æ‰€æœ‰ç½‘ç»œè¯·æ±‚éƒ½æ˜¯å¼‚æ­¥çš„
result = await self._client.integrate(hass_code=user_code)
result = await self._client.fetch_devices()
result = await self._client.fetch_pids()
result = await self._client.fetch_device_statuses()

# âœ… èµ„æºæ¸…ç†æ˜¯å¼‚æ­¥çš„
await self._client.close()

# âœ… åŒæ­¥æ•°æ®å¤„ç†ï¼ˆä¸æ¶‰åŠ I/Oï¼‰
def filter_sensor_devices(...) -> list:
    # åªæ˜¯è¿‡æ»¤æ•°æ®ï¼Œä¸æ¶‰åŠ I/O
    return [device for device in devices if ...]

def merge_device_status(...) -> list:
    # åªæ˜¯åˆå¹¶æ•°æ®ï¼Œä¸æ¶‰åŠ I/O
    return merged
```

**ä¸ºä»€ä¹ˆè¿™äº›æ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Ÿ**

`filter_sensor_devices` å’Œ `merge_device_status` æ˜¯åŒæ­¥æ–¹æ³•ï¼Œè¿™æ˜¯**æ­£ç¡®çš„è®¾è®¡**ï¼š

1. å®ƒä»¬åªå¤„ç†å†…å­˜ä¸­çš„æ•°æ®ç»“æ„ï¼ˆåˆ—è¡¨ã€å­—å…¸ï¼‰
2. ä¸æ¶‰åŠä»»ä½• I/O æ“ä½œï¼ˆç½‘ç»œã€æ–‡ä»¶ã€æ•°æ®åº“ï¼‰
3. æ‰§è¡Œæ—¶é—´æçŸ­ï¼ˆå¾®ç§’çº§ï¼‰ï¼Œä¸ä¼šé˜»å¡äº‹ä»¶å¾ªç¯
4. è¿™æ˜¯ Home Assistant æ¨èçš„åšæ³•

**å¦‚æœæ”¹æˆå¼‚æ­¥ä¼šæ€æ ·ï¼Ÿ**
- âŒ ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ï¼ˆasync/await æœ‰å°‘é‡å¼€é”€ï¼‰
- âŒ ä»£ç æ›´å¤æ‚ï¼Œå¯è¯»æ€§é™ä½
- âŒ è¿å"åªåœ¨å¿…è¦æ—¶ä½¿ç”¨å¼‚æ­¥"çš„åŸåˆ™

---

### 5. `sensor.py` - âœ… æ­£ç¡®å®ç°

#### å‡½æ•°åˆ†æ

| å‡½æ•°/å±æ€§ | ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |
|-----------|------|------|------|
| `async_setup_entry` | å¼‚æ­¥ | âœ… | å¹³å°è®¾ç½®å‡½æ•° |
| `__init__` | åŒæ­¥ | âœ… | æ„é€ å‡½æ•°ï¼Œä¸æ¶‰åŠ I/O |
| `native_value` | å±æ€§ | âœ… | ä»ç¼“å­˜è¯»å–ï¼Œæ­£ç¡® |
| `device_info` | å±æ€§ | âœ… | ä»ç¼“å­˜è¯»å–ï¼Œæ­£ç¡® |
| `_get_device` | åŒæ­¥ | âœ… | ä»ç¼“å­˜è¯»å–ï¼Œæ­£ç¡® |

#### å…³é”®è®¾è®¡

```python
# âœ… æ­£ç¡®ï¼šsetup å‡½æ•°æ˜¯å¼‚æ­¥çš„
async def async_setup_entry(...) -> None:
    # ä» coordinator è·å–æ•°æ®ï¼ˆå·²ç¼“å­˜ï¼‰
    devices = coordinator.data or []
    
    # åˆ›å»ºå®ä½“
    entities = [...]
    async_add_entities(entities)

# âœ… æ­£ç¡®ï¼šå±æ€§ä»ç¼“å­˜è¯»å–æ•°æ®
@property
def native_value(self) -> float | None:
    device = self._get_device()  # ä» coordinator.data è¯»å–
    if not device:
        return None
    return int(device.get("temp")) / 10.0
```

**ä¸ºä»€ä¹ˆä¼ æ„Ÿå™¨çš„ property æ˜¯åŒæ­¥çš„ï¼Ÿ**

è¿™æ˜¯**æ­£ç¡®çš„è®¾è®¡æ¨¡å¼**ï¼š

1. **Coordinator æ¨¡å¼**ï¼š
   - æ•°æ®ç”± `DayBetterCoordinator` å¼‚æ­¥æ›´æ–°
   - ä¼ æ„Ÿå™¨åªä» `coordinator.data` è¯»å–å·²ç¼“å­˜çš„æ•°æ®
   - ä¸ä¼šè§¦å‘ä»»ä½•ç½‘ç»œè¯·æ±‚

2. **Home Assistant è¦æ±‚**ï¼š
   - ä¼ æ„Ÿå™¨çš„ `native_value` å±æ€§**å¿…é¡»**æ˜¯åŒæ­¥çš„
   - Home Assistant ä¼šé¢‘ç¹è°ƒç”¨è¿™ä¸ªå±æ€§
   - å¦‚æœæ˜¯å¼‚æ­¥çš„ï¼Œä¼šä¸¥é‡å½±å“æ€§èƒ½

3. **æ€§èƒ½è€ƒè™‘**ï¼š
   - ä»å†…å­˜è¯»å–æ•°æ®æå¿«ï¼ˆçº³ç§’çº§ï¼‰
   - ä¸ä¼šé˜»å¡äº‹ä»¶å¾ªç¯
   - é¿å…äº†ä¸å¿…è¦çš„å¼‚æ­¥å¼€é”€

---

## ğŸ“Š ç»Ÿè®¡æ‘˜è¦

### å¼‚æ­¥æ“ä½œç»Ÿè®¡

| ç±»åˆ« | æ•°é‡ | çŠ¶æ€ |
|------|------|------|
| ç½‘ç»œ I/O æ“ä½œ | 9 ä¸ª | âœ… å…¨éƒ¨å¼‚æ­¥ |
| èµ„æºæ¸…ç†æ“ä½œ | 2 ä¸ª | âœ… å…¨éƒ¨å¼‚æ­¥ |
| å¹³å°è®¾ç½®æ“ä½œ | 3 ä¸ª | âœ… å…¨éƒ¨å¼‚æ­¥ |
| æ•°æ®å¤„ç†æ“ä½œ | 4 ä¸ª | âœ… åˆç†åŒæ­¥ |
| å±æ€§è®¿é—®æ“ä½œ | 3 ä¸ª | âœ… åˆç†åŒæ­¥ |

### ç½‘ç»œ I/O æ“ä½œæ¸…å•

æ‰€æœ‰ç½‘ç»œæ“ä½œéƒ½æ­£ç¡®ä½¿ç”¨äº† `async`/`await`ï¼š

1. âœ… `api.integrate()` - é›†æˆè®¾å¤‡
2. âœ… `api.fetch_devices()` - è·å–è®¾å¤‡åˆ—è¡¨
3. âœ… `api.fetch_pids()` - è·å– PID åˆ—è¡¨
4. âœ… `api.fetch_device_statuses()` - è·å–è®¾å¤‡çŠ¶æ€
5. âœ… `api.close()` - å…³é—­ API è¿æ¥
6. âœ… `coordinator.async_config_entry_first_refresh()` - åˆå§‹æ•°æ®åˆ·æ–°
7. âœ… `hass.config_entries.async_forward_entry_setups()` - è®¾ç½®å¹³å°
8. âœ… `hass.config_entries.async_unload_platforms()` - å¸è½½å¹³å°
9. âœ… `client.integrate()` / `fetch_*()` - åº•å±‚å®¢æˆ·ç«¯è°ƒç”¨

---

## âœ… éªŒè¯ç»“è®º

### å®Œå…¨ç¬¦åˆ Home Assistant æ ‡å‡†

- âœ… **æ‰€æœ‰ I/O æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„**
- âœ… **æ²¡æœ‰é˜»å¡äº‹ä»¶å¾ªç¯çš„æ“ä½œ**
- âœ… **å¼‚æ­¥å‡½æ•°éƒ½æ­£ç¡®ä½¿ç”¨ await**
- âœ… **æ•°æ®å¤„ç†åˆç†ä½¿ç”¨åŒæ­¥æ–¹æ³•**
- âœ… **ä¼ æ„Ÿå™¨æ­£ç¡®ä½¿ç”¨ coordinator æ¨¡å¼**
- âœ… **èµ„æºæ¸…ç†æ­£ç¡®å®ç°**
- âœ… **é”™è¯¯å¤„ç†æ­£ç¡®å®ç°**

### ä»£ç è´¨é‡

- âœ… **éµå¾ª Home Assistant æœ€ä½³å®è·µ**
- âœ… **ä½¿ç”¨ DataUpdateCoordinator ç»Ÿä¸€ç®¡ç†æ•°æ®**
- âœ… **é¿å…ä¼ æ„Ÿå™¨ç›´æ¥è¿›è¡Œç½‘ç»œè¯·æ±‚**
- âœ… **æ­£ç¡®åŒºåˆ†å¼‚æ­¥å’ŒåŒæ­¥æ“ä½œ**
- âœ… **æ€§èƒ½ä¼˜åŒ–åˆç†**

---

## ğŸ“š å‚è€ƒèµ„æ–™

### Home Assistant å¼‚æ­¥ç¼–ç¨‹è§„èŒƒ

1. **å¿…é¡»å¼‚æ­¥çš„æ“ä½œ**ï¼š
   - ç½‘ç»œè¯·æ±‚ï¼ˆHTTPã€WebSocketã€MQTT ç­‰ï¼‰
   - æ–‡ä»¶ I/O
   - æ•°æ®åº“æ“ä½œ
   - å¤–éƒ¨è¿›ç¨‹è°ƒç”¨
   - èµ„æºæ¸…ç†

2. **å¯ä»¥åŒæ­¥çš„æ“ä½œ**ï¼š
   - çº¯æ•°æ®å¤„ç†ï¼ˆåˆ—è¡¨è¿‡æ»¤ã€å­—å…¸æ“ä½œç­‰ï¼‰
   - å†…å­˜æ•°æ®è¯»å–
   - ç®€å•è®¡ç®—
   - ä¼ æ„Ÿå™¨å±æ€§è®¿é—®

3. **æœ€ä½³å®è·µ**ï¼š
   - ä½¿ç”¨ DataUpdateCoordinator ç®¡ç†æ•°æ®æ›´æ–°
   - ä¼ æ„Ÿå™¨ä»ç¼“å­˜è¯»å–æ•°æ®ï¼Œä¸ç›´æ¥è¯·æ±‚ç½‘ç»œ
   - åœ¨ try-finally å—ä¸­æ¸…ç†èµ„æº
   - åˆç†åŒºåˆ†å¼‚æ­¥å’ŒåŒæ­¥æ“ä½œ

### ç›¸å…³æ–‡æ¡£

- [Home Assistant å¼‚æ­¥ç¼–ç¨‹æŒ‡å—](https://developers.home-assistant.io/docs/asyncio_101/)
- [DataUpdateCoordinator æ–‡æ¡£](https://developers.home-assistant.io/docs/integration_fetching_data/)
- [Integration Quality Scale](https://developers.home-assistant.io/docs/integration_quality_scale_index/)

---

## ğŸ‰ æ€»ç»“

DayBetter Services é›†æˆçš„ä»£ç å®Œå…¨ç¬¦åˆ Home Assistant çš„å¼‚æ­¥ç¼–ç¨‹æ ‡å‡†ï¼š

- **æ‰€æœ‰ç½‘ç»œæ“ä½œéƒ½æ­£ç¡®å®ç°ä¸ºå¼‚æ­¥**
- **ä½¿ç”¨äº†æ¨èçš„ DataUpdateCoordinator æ¨¡å¼**
- **ä¼ æ„Ÿå™¨è®¾è®¡åˆç†ï¼Œæ€§èƒ½ä¼˜ç§€**
- **ä»£ç è´¨é‡é«˜ï¼Œæ˜“äºç»´æŠ¤**

**å¯ä»¥æ”¾å¿ƒæäº¤åˆ° Home Assistant å®˜æ–¹ä»“åº“ï¼** ğŸš€

