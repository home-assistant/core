"""Tests for the Habitica image platform."""

from collections.abc import Generator
from datetime import timedelta
from http import HTTPStatus
from io import BytesIO
import sys
from unittest.mock import AsyncMock, patch

from freezegun.api import FrozenDateTimeFactory
from habiticalib import HabiticaUserResponse
import pytest
from syrupy.assertion import SnapshotAssertion
from syrupy.extensions.image import PNGImageSnapshotExtension

from homeassistant.components.habitica.const import DOMAIN
from homeassistant.config_entries import ConfigEntryState
from homeassistant.const import Platform
from homeassistant.core import HomeAssistant

from tests.common import MockConfigEntry, async_fire_time_changed, load_fixture
from tests.typing import ClientSessionGenerator


@pytest.fixture(autouse=True)
def image_only() -> Generator[None]:
    """Enable only the image platform."""
    with patch(
        "homeassistant.components.habitica.PLATFORMS",
        [Platform.IMAGE],
    ):
        yield


@pytest.mark.skipif(
    sys.platform != "linux", reason="linux only"
)  # Pillow output on win/mac is different
async def test_image_platform(
    hass: HomeAssistant,
    config_entry: MockConfigEntry,
    snapshot: SnapshotAssertion,
    hass_client: ClientSessionGenerator,
    habitica: AsyncMock,
    freezer: FrozenDateTimeFactory,
) -> None:
    """Test image platform."""
    freezer.move_to("2024-09-20T22:00:00.000")
    with patch(
        "homeassistant.components.habitica.coordinator.BytesIO",
    ) as avatar:
        avatar.side_effect = [
            BytesIO(
                b"\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x8d\x00\x00\x00\x93\x08\x06\x00\x00\x00\xb3\x82\x9aN\x00\x00\x0c=IDATx\x9c\xed\x9d}pVG\x15\xc6o(\x08E\xbeI\x00C\xb0Q\x08P@)\x85\xd0\x12I\x07\x04\xca\x14i\xc1\xd1\xa1\xc0\xb4J!\"\xb4J\xa7\x95RKG\x8a8\x82\xa4\x19\xc6A\xc0Z\xa1\xe0\x07f\xa8\x82S\x8b|\x16354\x14B\x84*\x1f\x81P'@\x08P\xa0\t_\x01*P\xff\xdb\xf3\\\xdd\x9d\xf7\x9e\xde\xf7\xe3F\x9f\xdf_\x87\xcd\xde\xbd\xf7\xbe==\xcf\x9c\xddsw\xd3V,\xaa\xfa\xd8#DA\x93T?\x00i|\xd0i\x88\x9a\xa6\xf8\x8f\x01\xb9]R\xf5\x1c$\xe2\xec+?clF\x1a\xa2\x86NC\xd44\x8d\xdd\xa5\xf1\xf0\xfa\xf7\xbb\xc5\xec3\xe1''\x93\xf0$\xe1Y\xf2\xf5\x8c\x98}\x9e\xfd\xc3\xb9$<\xc9\x7f\xc3HC\xd4\xd0i\x88\x9aF)O\xa7\x7f\x9aom\x9f\xf9\xcc\xe3\xd6\xf6\xfa\xbd\xfb\x8c]\x0c\x12Vs\xec\xba\xb1S\x15\xea]2\xb4\xbc\xec\xd7\xd6\xf6\xfa}\xa5\xc6~\xd1qm\xa2\xdf\x85\x91\x86\xa8\xa1\xd3\x105\x8dF\x9eP\x92\x86\x16\xce56\x86\xeb\x03\xc5\xa5^,\xf2\xbbd\x1b;+\xbf\x95\xb1_\x86P\x9f\xe8\xf0\x8e\x92\xe4\x92\xa1\x9ds\x16\xc6\x1c\xe7\xc7\xcb\xbfem\x7f1\xc1\xef\xc2HC\xd4\xd0i\x88\x9aH\xcb\x93K\x92\\\xa1\xbb\xf4Lu\xcc1Q\x9ej\xaa\xae\x18\xfb\xb9'\x06\x19;\x11R\xe5\x92\xa40\xef\xe2\x15\x8b\x99\x95#R\x8b\xb2\x95\x08\xa9b\xa4!j\xe84DM\x1aV\xeeE\xa14\x02\xd7\x8fp\xb2\xce\x95\x19a\x18\x7f\xeb\xe0\x15k\x9f\x91}[Y\xdbQ\xaa\\\x14\xef\xac46\x86\xf7\xe9\x0f\xb7\xb7\xf6\x7f\xf5\xcd:k\x9f\xf5+g\x1a;\xc8\xbb A\xde\xcb\x97\x15\xe6\xd8\xdf\xf7\xe5\xd5{\x8d\xad\x95*\x96F\x90P\xd0i\x88\x9aHgO\xb8f\x84\xb8$\t\xa5\x01A\x99\xf8\xe1\x88~\xd6q\\R5iho\xeb8\x8b\x9b\xf7\xb3u\xf7\xf5Y5\xe3~c\x87\x91\xa4 \xef\xe5y2N\xbe\x97ml\x97T\x85\x81\x91\x86\xa8\xa1\xd3\x105\x91\x93',W\xa8\xe9b\xcf\x1a\x82\x84n\xc4\x95\xd1\x04\x91\xaa\x97v\x1c06JR\xbf{\xa4\x0f\xb2x\xbf\xd8\xd3^y\xf7\x13\xdf+\xcc{\xe5;\x92\xe0\xca\x1b7c\x8e\x19\x04F\x1a\xa2\x86NC\xd4DB\x9ep]\x06\xd7\x80pm(\xd0Z\x8c\x12\xd7\x98\xaev\x94\xa4V\x03r\x8c}e_U\xdc\xef\x15\x06\x9f\xfcA&\x85\xd9\xdc4\x90\xb3 R\x880\xd2\x105t\x1a\xa2&\x12\xf2\x14\x04m\xc6\xe4\xc2\x95q\xe0:\x0e\xde\xab\xe4\x0b5\xc6\xbep\xf5\x82\xb1[\xbe\xd3Ql\x18\xbf{\x8e\xf4)I\x93>\xc3\xff\x91\x15\xf3^a\xdek\xe0\xf0\\\x19\xb3\xa4\xdc\xd8\xaeL*\x0c\x8c4D\r\x9d\x86\xa8\x89\x84<\xe1\xa4\x13fL\xb8n\xd2{\xa7\xfdQ\xff\xb2a\xaa\xb1\xcf\xef\xd9n\xec\xf4\xc1\xa3\x8c]U-\x12\xf3\xedg\xb7Y\xc7A\x99(n/%\x04\r-g\x18\xfbN\xe8\xdf`\x1d\xc5\xf3\xde\xdf_-6\xb4o\xbd\xf4/c\x8fn\xd3\xccq\xb5\x1d\xd7\xe7\xc6\xaeO\x8c{7O\xec\x7fVF\x1a\xa2\x86NC\xd4\xa4L\x9e\xba\xb5\xb4O.\xf9J\x0brd2*\xabG\x0bc\xa3$\xa1\xf4\xe4\x80$ed\x88\x1c\xdc\xdbS\xb2\x98_,y\xd0\xd8\xe3\xdb\xa6\x1b\xfb\xd1&[\x8c=\xa9N&\x18\xbd\xddb\xba\xd6\x9e\x0e\x80$!\xf7\x9c\x93\xd2\x8eo.\x92v\x94\xaa\xa73D\xf4\xa6;&\xdcp=\x0e\x8b\xd2\x17}Cd\xeb*\xf4\xc1\xdf\n%\x1e\xd7\xc20\xdb\xd2\xc2HC\xd4\xd0i\x88\x9a\xd4eO\xd5\xb0L\xdf\xc9\xde\x053\xa9\xbaNw\x1b\xfb\xc1\x9e\xd7\x8c\x9d\x91\xd1\xd9\xd8e\xe5\"U\x9e\x97\x05\xedg\xad\xe3\x9f\xbc\xf7s\xc6n\xd30_\xfe\x00\x92\xb4y\x95<\xe7C\xd3\xa0Lb\xbf\xfd\x99\x9f\xbf!}6\xff>\xcd\xd8\xbfzAv\xde\xfdy\xb7\xcf\xd8/\x0e@\xf5/\x97\x1a;\xc8.\x19\xf8\x1b\xc6\x0bF\x1a\xa2\x86NC\xd4\xa4L\x9eNv\xbalmweR7{\xb5\x91N\xdbz\x19sw\xed\x11c?\x967\xc2\xd8\xbe\xac*[\xa4\n\xb3\xaan\xedEz\xe6m\x13\t\xf3e\x16\xd9\xb2\x8e\x83\x04\xc9\x9e\xbcl\xf9y1K\xea\xdd\xa2\x9d\xbd?P\xb4X\xde}\xd9{\x1b\x8d=\xab\xffxc?\xe7\xb8\x16%\t\xab\x01'>\xf1Uc\xe3\xef\xa3\x85\x91\x86\xa8\xa1\xd3\x105\x91X{B\xa6\xce\xbeK\xfe\x01\x924w\xdeS\xc6^\xbbv\x9d\xb1\xd3>\x92\xb5\xff\x0ey\x92\x95\x8c\x18)\xdf+\xedX\xf9\x96\xb1\xab\xaa\xed\xf7E\t\xdb\xff\xbb7\x8d\xdd\xb0\x15\x8b\xb1\xe5\xe7rJ\x12\xe0\xba\xb6\xf2z}\xcck\x0f\x9f\xeai\xec\xf6\xe9\xf2.\xef\\\xed.\x9d\xe03[\x04\xd7\xf2\xbe;g\xac\xb11\xbbt\xad\xc1\x05\x81\x91\x86\xa8\xa1\xd3\x105I\xdd5\x02\xd7\x9bF=\xd9\xc6\xda\x07e\xe8J\xc3Ec\xbf\xf1GY\x1b:q\x18B}\xa5\xec\xea0\xe5\xe9\x81\xc6\xce\x1d8\xc4\xd8\xe5\x15\xbb\x8c}\xfb\x88\\\x8b\x92\xa4\xcd&&\x94]\xb3\xb6\xaf\xf6*\xad\xed\x981\xa1<\xa1\x94\xfch\xa8\xac\x19\xcd}{\xa8\xb1\xeb?\x96\x12\x88!\xc3$[<tN~\xc3\xfb2%\xa3\xcc\xcb\x95\t\xcfs\xe7\xece\x18A\xcaE\x10\xee\x1aABA\xa7!j\x92\x9a=\xa1$\xb9d\xa8\xa4t\x8bg#\xf3\xb3m\xc1\x96\xf6\xfbG\xdb%)\x08\x18\xa21\xa4\xe3\xa4\xdf\xbamR(\x8e\x92\x84kL\x08\x96O\xecj!!\xdd%I\x17n\x8a\xac\xcc}[J\x1dP\x92\xda\xe5\xc8\xba\xd5\xb2\x952\xd1\xf7\x9d\x02\xc9\x8c\x10\x94$\x97\xec2{\"I\x85NC\xd4\xa4lro\xe1\x82\xe5q\x1f3\x88<5\xe9%\xd2\x80\x99\x94\xab|\xa2\x02\xbe!\xaa\x80\xf6\x82\xb1\xfd\xad\xfd\x9f\xdf\xf8\x9e\xfc\xe3\x86\xfd\x19P\x92.\xf7\xee#\x7f\xa8<d\xcc\r\xc3\x0f\x1a{j\x8d\xf4\xc1\x89>-a$\ta\xa4!j\xe84DMR\xe5\xe9\x8dq\x1f\x1a;g\xbed\x04{\xca\x0f\x1b{p\xee\xdd1\xdb\xfb\x0c\x90B\xf1Y\xb3\x1f\x8by_\xd7D\x1f\x82\xd9\xd3\x7f\\m\xac\xca\x0f\xe5\x99\x8b\x1d\xa7\x1a~\xba\xbf\x14\xa5\x17,\x14)\xf9\xdeZ\xf9R\xea\xf6\x1e\x19\xa75H\x12fI(I\xf5UR\x01\x98\xd6\xc4\xbe\x15\xadk\xa22^\x92\x840\xd2\x105t\x1a\xa2&e\xd9\xd3\xa9b\t\xb9\x83'\xd9\xa5j\xca\xf4\xa1\x9e\r\x97$--\xfam\xcc>\xc8\x99;e\xe2\xae\x0c\n\xf40\xd4\xfbd\x0b2\xac\xc9K\xe5\x1b\xab\x1d\xfbV\x19\xfb7\x93\xdb\x19{\xdeh\x19\xb4l\x86\xbc\x977\xcc\xb3\xdb.\xa4 \xd1\x9b\xfc\x88Hs\xebf\"\x9d\x89\x96$\x84\x91\x86\xa8\xa1\xd3\x105)\x93\xa7\x82\xf5R\x99v\xbc\xb0\xa3\xb5O\x10\x19\nC\x97k\xf6\xfb\xfa\xd7k\xb2\xac}P\x92>8\xf1\x91\xb1/\xdf\x92\x83*\xde}\xea\xbc\xb1\x9bu\xb8m\xec\x962\xb7\xe7\x07\n\xd1\xf1\xbb\xb0\x06\xa9\x86\xf0\x16\xc0\xdc\xde\xa5q\x89\x95!\x17\x8c4D\r\x9d\x86\xa8I\xaa<]\xc8\x97o\x9d\x96z\xad\x8d=\xee\xfd\x0e\xd6\xfe.\x19\xda\xbe\xe2\x92\xb5\xddU\r\x18\x04\xd7\xb7QX\x8c\xed\x9b@[-\xd7\xae\xdf\"\xdb\x17e7\x97\tL\xc4'I\xd9\x8e\x9f\x1d?Uv\\{\xd1>7\x99T\x18i\x88\x1a:\rQ\x13\x89\xef\x9epM\nqf\x19qzl,\x93\xa8:b\xcf\x98\\k:X\xc5\xd7\xad\x13\xfe\xbf\x97\x0e\xf6\x07\xf1xL_\xf6\x14\x05\x18i\x88\x1a:\rQ\x932y\xc2L\xaac\xa9dR(I\x18\x96}R\xe5\xc82\xb6\xcf\x11\x99\x1bUh_\x87r\x95I\xb8\xa4\n\xd7\x9e\\\x9f\xf4\x0e\xb9.\xdf\x8ba\xc1\xf9D\xe8\xe3{\x17/\xf6\xb9KQ\x93$\x84\x91\x86\xa8\xa1\xd3\x105\x91\xc8\x9eP\xaa<\xadTy\xf6>A\x08\"U\x1b\x0eHe\x1dnY\xbe\x14\xca\x15f\xed\xc0#5\x84\xf9[\xe5\x82'\x1f\x90-[\xbbz\xb7T\xcfy\xea\xd4\x1d\xc6n1\xb1^um\"`\xa4!j\xe84DMRw\x8d\xd0\x82YU\x10P\xe6|\x9b#\x01A*\xfa\\\xc5\xe7Z\xda\x96\xca1\x855\xb0K\xb9O\xaa\xba\xda\xa5*j\x92\xc4]#H(\xe84DMB\xb2\xa7\t\xb3\x87[\xdb_/*Q\x8d\xe3\xcb\xaa\x92\x88v\xf7\t\x97\x9c]\xcc\x97\x13u'U\x89<\xad\xf8\xab\xc8\x16J\x15\x12\x05Ir\xc1HC\xd4\xd0i\x88\x9a\xb8\xc9\x13J\x92K\x86\x82\xf4I\x04\x981\x05\xf96\xaaUK\xd9@\t7\\Bp\x1c\xd7\x06MH\xd1\xbaW\xac\xed\x95\xc3\xe4Z\x1c\xf3\xb5\x89\xb6\xde\xd1\x80\x91\x86\xa8\xa1\xd3\x105I]{BIJ\x95T\r\x19.;~\xbb\n\xd7Qn\x82H\x15\xe2\xea\xffx\xe1\x0c[\xf7F\t#\rQC\xa7!j\xe2&OQ\x90\x1e\\o\xc2\xcc(\xc8Z\x12\xee\xf8\x8d\xfb\x01\xa2T\xa1\x9c\xdd\xd5==f\x7fm\x16\xf6Z\xd1\xf1\x98\xcf\x19\x05\x18i\x88\x1a:\rQ\x93\x90\xec)\x99\x93{A$iW\x89|6\xfb\xcc\xb8\x07\x8c};S^\x1f7\x02\xda\rc\xe2YQK\xa6\xe4\x19\x1bw2?\xee\xc9\xee\x10.\x19\xd2faQ\x86\x91\x86\xa8\xa1\xd3\x105MO\x9f\x90\xca\xb1\xf6\xadu\x05\xcf\xc8\x9c\x95#c\xf6),\x90P_]\x19\xfb^8&^\xbb`\xe5\xe7\x8d\x1dd\xb2\x0eO\xd1\xc5] v\xd4J\xb9\x02J\x92K\x86\xfevT\n\xc5\xfd{\xf1\x89\xe9Z\xdb\n\"IA~\x93T\x81~\xc2HC\xd4\xd0i\x88\x9aP\xd9\x93K>\xb4\xbc0\xc7\xbe\x0b\xf7\xeec\xa7\x8c\x9d\xd7\xc3\xdeg\x97'\x99\x91\xfbH>\xe9\xef\x93\xa4M\x7f\x92k\xc7<bl\x94$\x1c\x07\xa5\xcd\xb5\x17\xdf\xbc\x82\x7f\x1a{A\x91\xc8h\x90\x82\xf6\xc6\x02#\rQC\xa7!j\xd4\xf2\x94\x08I\xea\xfbe9V\xef\xef5\xa7\xad\xfdo\xf5\x94c\x07\xbf\x98%\x87\xb6\xffy\xa3\x1c\xbc~x\xbfL\xe8\xad\xd9$\xd7N\x19\xa3+\x14\xf7K\xd2YG\xbbH\xd5\xe81\x9b\xad\xe3\x04\x91*\xb4\xb1\x0f^\x1b5\x18i\x88\x1a:\rQ\x13H\x9e\x12-IA\xc0L'33\xd3\xd8_\x19\xfbp\xcck\xd7\x80\x84\xd5\xd6\xd6\xc6\xec\xef:\x00=\x0c\xffKR\xc5HC\xd4\xd0i\x88\x9a\x84\x17\x96\x87\x91$D+I\x08\xf6\xc7q\x82H\x15\xe2\x92-\\\x0bsI\xc9\xb1\xba\x9f\x19\xbbW\xb6\x94gh\xcf\xa8\x8a\x02\x8c4D\r\x9d\x86\xa8I\x88<\x85\x91\xa4\xce\xcd\xe4\x98\xc20\x92\xe4\xc2%U\xaf\xbe4\xde\xd88q\xe7\x9a\xd0\xdb]+\x1b\xfc\x05\x91\xa4\x8a\n9\n\xfe\xe8\xd1\xa3\xd2\xe9Sb\xc6k3\xa5D\xc3HC\xd4\xd0i\x88\x9a@\xf2\x84\x13z\xf1\x9a\xe8\x0b\x03\xae7\x05\x91\xad \xfd]\x99\x91\xab=\xc8\x84\x1bJ\xd2\xa3#\xd7\xc8\x1f\xa0\xc8\x113/\x04\xbf\x9fZ\xb0 Z\x13}\x8c4D\r\x9d\x86\xa8\x89\xc4\x8e\xe5Z\xae\xf7\xfa\x92\xb1[8\xa4\x07%\t\xfb\x7f\xcd1\xa6\xff\x84\xdc\xf8\xe0\x93$\xc0U\x18\x8f\xdfgy\xde\x96\xb8?O\xbc`\xa4!j\xe84DM\xa3\x94'\xc4\x95\r\xf9\xda\xab\xec\xc7\x1d\"X}\xb7u\xd3Criu\xec\n\xbd \xb8\xb2$\x94$_\xf9D\x80\xf5\xacT\xc1HC\xd4\xd0i\x88\x9a\xb4\x1f\xcc\xac4\x07j\xf4\xe9\xab;P\xc35\xd1\x17\xafr\x88\x83\x95\x87\x8d]}\xec\x98\xb1\xc3\xacCaVU\xbc\xac\xfe\x13\x8f\xf3\xff\xc6\xa1\x83<P\x83\x84\x80NC\xd4\x84\x92'\xc4\xb5k\xc4\x1dG+\xac\xed\x88K\xc2\xce\x9e\x95\x90x\xbe\xae\xce\xd8Z\xa9BI\x1a\x94\x9b+c\x1e\xdck\xecE\x85u\x1eqCy\"\xa1\xa0\xd3\x105q\x9b\xdcs\x95I\xa0l\xe1\xb7KH^\x8f\xae\xc6N\xef;Hu_\x94\xb0\xce\x9d\xbbX\xdbI|a\xa4!j\xe84DM\xc2\xd7\x9eP\xb6\xee\x1bc\xcf\xb0\n!s\xf1mp\x94\xd9\xdd\xd2\xdb\xf3\xb2{\xf40\xf6\xder\xd9\xf0\x0e\xbfc\xc2\xa2q\xcc\x98Hx\x18i\x88\x1a:\rQ\x93\xd4\xd2\x88 \x85\xe8\x8b\x1cRU\xe6\xdb\x7fO\xb2-\\?B\xf9\xc3\xf6 \x19\x1c^\x9b\xaa\x82\xf9\xc6\x02#\rQC\xa7!j\"]\xb9\x87\xfb\xec!(UAd%P\x06GI\n\x0c#\rQC\xa7!j\"-O\x89\x90\x15\xcaPx\x18i\x88\x1a:\rQ\xe3\xab\xdc#$\x08\x8c4D\r\x9d\x86\xa8\xf97}\"\xaf\x8b'\x82\x81p\x00\x00\x00\x00IEND\xaeB`\x82"
            ),
            BytesIO(
                b"\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x8d\x00\x00\x00\x93\x08\x06\x00\x00\x00\xb3\x82\x9aN\x00\x00\x08!IDATx\x9c\xed\x9d_l\x14U\x14\xc6\xcfHE\x8aR\xfe$bC\x85`\xaaT\xbab\"j()\xffb\x001\xc1\x12\x906\x01\x0cj\x94\x18c\x02\x94\xc4\x07\x14| *\x0f&\x16I\xf4\x05\x8d>\xa8\x18\x8a\xfa\x80\x89\x88<\xa0\xd0X\xa3B\x04Z4\x84\x10\xa9\r\x95\x04(-\x08!\xc0\xf5ag\xee=\xb3{\xa7;\xa7\xed\xee\xcet\xbe_\xd2r\xf6\xee\xb9w\x97\xcc\xb7\xe7\x9b3;3u>\xdczR\x11\x00\x02n+\xf6\x1b\x00\xf1\x03\xa2\x01bJ\xf8\x83G\x1e//\xd6\xfb\x00\x11\xe7\xc8\xaf]:F\xa5\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01b \x1a \x06\xa2\x01bJr\xa7\x00\x8f\xc6M\x0b\x88\x88H)E\x8e\xe3Xs\xbc\xe7\x94R\xb4\xed\xed\xfd\x85|{\x05\x03\x95\xa6\x9f(\xa5H)\x95\x15{b\n\x12\xd5P\x00\x95FH_UF\x92\x13g \x1a\x0b\x8d\x9b\x16X7\xfc\xaa\x9aq\x19\x99\x0e\x11)\xdf\xe3\xf4Hzl\xfd\x1b\xf3\xd3\xa3\xee:^5\x8a\xbbmA4!\x08\xae\x1cF0\x0e9\xa4\xc8\x08F\x8f\xbb\xfb7^<\x14\xc0>M\x0e\xf8~K\xba\x8ex8\x94\x96\x8a[E\\\xc9p\x86\x8aH2A\xa5q\xe1V\xe2\t\x85\x88h\xee\xbd\xd7\xd2\xb2p\x1c\xea\xb9\xfc\x1f9\x0e\x91RD\xa3\xee\x1aI\xd9u\x85\xe8\xf2\x95\xab\xbe\xb9DD\xa4\x14\x1d\xf8g\x84^\x97waq\xb4*T\x9a\x0c\xb8`\x88\xdcj\x91Q1\xccC'\xe3_o\x8d\xf4\x8f~\xe08YU'\xce;\xcb\x10\x8d\x0bo\x95\xbd\x1f\xc5\xb7\xbe2b\xf1\x86\x1c\xfd\xdbXW\xfa9\x95%\xacL\x91dV\xb48\x01{bx\x1bun\xc5Uo\x80\xf6\xa6\xba\xf5\xf37\xaf\x9e\xd7\xf1\xb0R\xfb\xe7\xed\xe6\xf0[&g\x82\xc9YDcu|\xa0\xe3\x8e\xd8V\x19\"T\x1a\x1f\x99\x9f\xfcA\xad\x04l-\xaf\xca\xc4U8\x10\x8d\x8bO \x96\xfd\x98\x81\xe3h\xe1\xf0\xaf\x1a\xe2H\xa2\xed\xc9\xebb\x88\xcc\xa7_)E\x9f\x96\xfe\xa5\xc7\x9f?^\xe5\xee\xb6x\x1b\xd8!E\xca\xec\xfa\xba\xed\x94\xa2\x80\x16[)\"rh\xdd\x97G\xf4\xd0\x8f\xb3gZ\xdfC\xd3[?\x0c\xf8\xffT\x08Pi\x18\xd6\x8d\xee\t\xc61\xc7c\xbc\x16\xdcT\x0f\xd6\x1d\xf9Z'//\x8f\xb6W\x04\x12]ild\tGwOn\xeb\xecKv\x7f\xb9\xc2a\x8b\xb0\x16+\xf8\xdb\xf0\xb8\x92x\xd1x\xfb\x17\xa7\x1f\xf8C\x8f\xad\xee\x9d\xe4\x1e\x01&\xbaE\xd7\xc8\xab\x14?u\x8d\xb5/\x12\xc07\x87Zu\xfc\xdcV\xfb\xf8\xb2\xd93c'\xa0D\xdbS`\x07\xa3\xd8>K\xd61\xdf\xfc\x10\xa7N*\xf1\x95\xa6O\x1c\xa7 \x9a\x89\x93`\x88\x12.\x1a\xbe\xb1V\xf7L\xccNP\xcagI3F\\\xb0\xae\xf3\xc4\xf0\xb3\xd6\xf1\xa5\xb3jt\xcc-\xa9iy\x15\xcb\x1a\x17;{J\xb4h\x88\x8a\xbfC\x1a\xc7\x83|\x89\x17M\xb1\x89\xe3A\xbeD\x8b&hcqKjmm\xb5\xe6loxL\xc7\x7fS\x99\x8e\xd7\xee\xfaM\xc7KX~M\x8d\xb1\xaa9\xe5\xb9\xdfC\x94It\xf7\x14\x85\x93\xc0\xa3\xf0\x1e\xa4$Z4\x1eQ\xf8\xb4G\xe1=\x84%\xd1\xf6\xe4\x11\xf6S\xce-f\xe5\xa4\xdc9A\xd6\x16\xc4\x8bkgX\xc7?\xde\xfe\x8b('\xdf$\xbe\xd2\xc4qG\xb4\xd8$^4\xc5\x16L\xb1_\xbf?$\xda\x9e\x826\xd8\xc6\xb26\x1d\xaf\x9b7E\xc73F\xf0\xac2\xb2\xc1\x0f\x00\xf2\xb9\x1b\xcb\xcc\x01\xc0\x16\x9a`\x9d\xfbN\xc5\x19\x1d\xbf\xdei\xfc\x8f[Rss\xb3\x8e\xeb\xeb\xeb\xad\xeb\xe4\x9b\xc4W\x1a \x07\xa2\x01b\x12mO\xfc\x9a#~\x06\x1d\xddc\xc2\xca1\xa3\xacsO\x9d\xeb\xb1\x8eW\x8e\xb7\xdbV\xcbu\xd3\xa1\x1d\xfc\xd7\\\xde\xbb\xb1\xec\xb8\x8egM\x1bf&t\x9a\x90[Ruu\xb5u\xfdB\x82J\x03\xc4@4@L\xa2\xed\x89\x13t\x85\xc0\x17gJ\xf4\xf8\xcaI7\xf4x\x90\rqvv\xdc\xae\xd7\xb3}\xdf\xe48\x8e\xafK\ncI\xa9TJ\xc7\x85<\xa0\xc7A\xa5q\xc9u\x90\xaf?\xdf\r\r\xb5\xbbEx@4.\xb9\xcek\xe9\xefA\xb8|\xacYl`O.\xbd\xbd\xbd:>\xe8\x98\xee\xa6\xae\xeei\x1d\x9f9\xfc\x95\x8e\xbb/\xda\xbb\xa71c\x8dm\xd5\xd5\xd5\xe9x\xcf\x9e=\xec\xb5\xecs\xa3lI\x1cT\x1a \x06\xa2\x01b\x12mO\xfc\x80\xde\xcb\xa9R\x1d\xef\xec09\xa7O\x9d\xd2\xf1h6\x97\xdbP\x10|n\x10q\xb1$\x0e*\r\x10\x03\xd1\x001\x89\xb6'\xce\xd1\xf3\x97t\x9c\x1ai\xc6\x8f\xb7\xb7\xb3q\xd3\xf5L\xac\x18o]\xa7\xa3\xf3\x9c\x8e\xdb:\xcd\xdc\x9e\x1e3w\xd9\x14s\x900.\x96\xc4A\xa5\x01b \x1a \x06\xf6\xe4\xc2\xedf\xef\xc9[}d\xa6\xe16$\xe5l\x8fY\x7f\xf3R~\x89n<6\x07*\r\x10\x03\xd1\x001\xf1\xa8\x87DT\xff\x94\xfd\x0c\xba04\x7f\xd7k\x1d\xe7\xf7\xb8\x0b\xba\xf7\x9d\xef\xbe|\x93\xe7\xe8\xf8\xbe\xcaJ\xeb\x9a\xbe\x03z\xac\xf3\n\xbcv\xa9\x8b\xac9Q\x06\x95\x06\x88\x81h\x80\x18g\xf3+\x7f\xea\x93:\xaaS\xe5}\xe5\x16\x84\xd7\x1a\xc7X\xc7[\x0e_\xec\xf7\x9a\xb5\xd3\xed\xf7\xca{\xb7\xa9;\xe7\xdc}\xbb\xa6\xe9\xb8b\\i\x1f\x99\xd9t^0\x7f\\ca\xc31\xd1\xdc\xa8\xd1\xdef|\x14\x95\x06\x88\x81h\x80\x98\xbcwO[>0wQx\xf3U\xfb]\x14\xb8%\x05\xd9\xd0Gk\xcc\xf9\n/\xed\xb0\xdc\x1f\xaf\x8f\xfc\xa05k\xa7\x9b\xd7\xe5V\xf5\xfeg\x8bt<u\xb8\xc9\xe7vs\xe2z\x85u\xcd\xa9\xc3;\xad\xe3|\xcdu\xcf\xee\xb5\xe6\xc4\x05T\x1a \x06\xa2\x01b\xf2bO\xdc\x92\xdakku\\\x1d\xc2\xaa8\xdcb\xc2\x8c\x87Y'\x8c\xb5qx\xc7\xb4\xbf\xcb\x9cp\x1ed1\xdc\x86\xe6\x97\x9b;H\x9c\xe8\xb2e\xc7\x13T\x1a \x06\xa2\x01b\x06\xcd\x9e\xb8%Um;\xa4\xe3\xea\xf5\xb3t\x1c\xc6\x92\x82h\xbbr@\xc7\xa9;\xe7\rz>\x87[\x8f\xb4\xeb\x19\xc8\xdc\xb8\x80J\x03\xc4@4@\xcc\xa0\xd9\x13\xb7\x9e-\xeb\x8dU-\x1f\xbd\xcb\x8c3\x0b\x93\xf2\xf5\xb1\xb5\xe6\xc1\xb4\xed:\xe4\xd6\xc3-\x89\xe7\xa7j\x8e\xf6\xfbu\x07b+C\xc9\x928\xa84@\x0cD\x03\xc4\x14\xf4\xcc=nU\x9f\xfc\xfe\xb0\x8e\xa5\xa7=\xcc\x99\xbc\xc4>~\xb7\x19\xf7\xd9Y\x00\xfcu\x83\xbe\x87\x02\xd9\xa0\xd2\x001\x10\r\x10\x93\x17{\xf2uR\x01\x1d\xd33U\x07u\xcc\xcf\xac\xe3\x96\xd1s\xd9\\*\xbbY\xd8\x01\xf1|\xbe\x0e\x91\xf9\xee\x89\xbf.,)<\xa84@\x0cD\x03\xc4\xe4\xbd{\ncUAl\xd8\xf9\x90\x8e\xdf[a\xee\xec\xdd\xdc\xdd\x90s\xee\x93%;\xac\xeb\x80\x81\x83J\x03\xc4@4@L$.\xcb\x1du\xff\x83:\x0e\xea\xa4|\x16\xb3\xc2X\xcf\xf77\xd6\xe88\x8c%\xa1c\x1a8\xa84@\x0cD\x03\xc4D\xc2\x9e8R\xab\xda@?\xe7\\\x13\x964\xb8\xa0\xd2\x001\x10\r\x10\x13\t{Z8\xcct=\xfbn\xae\xe9#3M\xd0] \xfc\xa7:\xc0\x92\xf2\x05*\r\x10\x03\xd1\x001\x05\xb5\xa70\xdfC\x05\xe5p\xbby\xe1Qs\xda\xc3\xeeK\r\xd6\x1c\xde\x85\x81\xc1\x05\x95\x06\x88\x81h\x80\x98\xa2uO\xd2Kt\xb9%\x85\xc9i\xfc\xdc\xdc+\xafv\xf1\xd4~\xbf.\xc8\x06\x95\x06\x88\x81h\x80\x98H\x1c\xdc\x0b\x03\xb7\x9b\xa6U\xe6\xf6\xaa-\xdf\x9e\xd01\xb7\xa1\xdd\x8b\xcd\\X\xd2\xe0\x82J\x03\xc4@4@L\xa4\xed\x89\xdb\n\xb7\x1e\x0el\xa8\xf0\xa0\xd2\x001\x10\r\x10\x13i{\xe2\xc0z\xa2\x03*\r\x10\x03\xd1\x001>{\xe2\x7f\xd3\x07\x80 Pi\x80\x18\x88\x06\x88\xf9\x1f6\x8c\xa2\x01>c\xa6~\x00\x00\x00\x00IEND\xaeB`\x82"
            ),
        ]

        config_entry.add_to_hass(hass)
        await hass.config_entries.async_setup(config_entry.entry_id)
        await hass.async_block_till_done()

        assert config_entry.state is ConfigEntryState.LOADED

        assert (state := hass.states.get("image.test_user_avatar"))
        assert state.state == "2024-09-20T22:00:00+00:00"

        access_token = state.attributes["access_token"]
        assert (
            state.attributes["entity_picture"]
            == f"/api/image_proxy/image.test_user_avatar?token={access_token}"
        )

        client = await hass_client()
        resp = await client.get(state.attributes["entity_picture"])
        assert resp.status == HTTPStatus.OK

        assert (await resp.read()) == snapshot(
            extension_class=PNGImageSnapshotExtension
        )

        habitica.get_user.return_value = HabiticaUserResponse.from_json(
            load_fixture("rogue_fixture.json", DOMAIN)
        )

        freezer.tick(timedelta(seconds=60))
        async_fire_time_changed(hass)
        await hass.async_block_till_done()

        assert (state := hass.states.get("image.test_user_avatar"))
        assert state.state == "2024-09-20T22:01:00+00:00"

        resp = await client.get(state.attributes["entity_picture"])
        assert resp.status == HTTPStatus.OK

        assert (await resp.read()) == snapshot(
            extension_class=PNGImageSnapshotExtension
        )
